<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siripala AI - Smart Study Assistant</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(241, 245, 249, 0.5); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 10px; }
        .chat-container { height: calc(100vh - 220px); }
        .markdown-body pre { background: #0f172a; color: #e2e8f0; padding: 16px; border-radius: 10px; overflow-x: auto; border-left: 4px solid #6366f1; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-animation { animation: fadeIn 0.3s ease-out; }
        .gradient-bg { background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899); background-size: 200% 200%; animation: gradient 15s ease infinite; }
        @keyframes gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-effect { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .shadow-glow { box-shadow: 0 10px 40px rgba(99, 102, 241, 0.15); }
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-3px); box-shadow: 0 10px 30px rgba(99, 102, 241, 0.2); }
        .gradient-text { background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-indigo-50 font-sans h-screen flex flex-col overflow-hidden">

<header class="glass-effect text-gray-800 p-4 shadow-glow z-10 border-b border-slate-200/50">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="relative">
                <div class="w-12 h-12 rounded-xl gradient-bg flex items-center justify-center shadow-lg header-icon">
                    <i class="fa-solid fa-graduation-cap text-white text-xl"></i>
                </div>
                <div class="absolute -top-1 -right-1 w-4 h-4 bg-emerald-400 rounded-full border-2 border-white animate-pulse"></div>
            </div>
            <div>
                <h1 class="text-xl font-bold gradient-text">Siripala AI</h1>
                <p class="text-xs text-slate-500">IntelliJ â€¢ Spring Boot â€¢ RAG</p>
            </div>
        </div>

        <button onclick="openModal()" class="gradient-bg text-white px-5 py-2.5 rounded-xl text-sm font-semibold hover-lift transition-all shadow-lg flex items-center gap-2 group">
            <i class="fa-solid fa-cloud-arrow-up group-hover:animate-bounce"></i> Upload PDF
        </button>
    </div>
</header>

<main class="flex-1 max-w-6xl w-full mx-auto p-4 flex flex-col">

    <div id="chat-box" class="chat-container glass-effect rounded-2xl shadow-glow p-6 overflow-y-auto mb-6 flex flex-col gap-6 border border-white/50">
        <div class="flex items-start gap-4 message-animation">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center flex-shrink-0 shadow-md">
                <i class="fa-solid fa-robot text-indigo-500"></i>
            </div>
            <div class="flex-1">
                <div class="bg-gradient-to-r from-indigo-50 to-white p-5 rounded-2xl rounded-tl-none shadow-sm border border-indigo-100/50 max-w-[85%]">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="font-semibold text-gray-800">Siripala AI</span>
                        <span class="text-xs px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded-full">Assistant</span>
                    </div>
                    <p class="text-gray-700 leading-relaxed">
                        Hello! I am your AI Study Assistant. Upload a lecture PDF and ask me anything! ðŸŽ“
                    </p>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button onclick="suggestQuestion('Summarize this document')" class="text-xs px-3 py-1.5 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition">Summarize</button>
                        <button onclick="suggestQuestion('Create study notes')" class="text-xs px-3 py-1.5 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition">Study Notes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white p-2 rounded-2xl shadow-xl border border-slate-200/70 flex gap-2 items-center">
        <div class="flex-1 flex items-center gap-2 pl-4">
            <i class="fa-solid fa-message text-slate-400"></i>
            <input type="text" id="questionInput" class="flex-1 p-3 bg-transparent outline-none text-gray-700 placeholder-slate-400 text-sm" placeholder="Ask about your PDF..." onkeypress="handleEnter(event)">
        </div>

        <button onclick="startVoiceRecognition()" id="voiceBtn" class="w-10 h-10 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 transition flex items-center justify-center" title="Voice Input">
            <i class="fa-solid fa-microphone"></i>
        </button>

        <button onclick="askQuestion()" class="gradient-bg text-white w-12 h-12 rounded-xl hover:shadow-lg transition-all flex items-center justify-center shadow-md group">
            <i class="fa-solid fa-paper-plane text-lg group-hover:scale-110 transition-transform"></i>
        </button>
    </div>
</main>

<div id="uploadModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50 transition-all duration-300">
    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md transform transition-all duration-300 scale-95" id="modalContent">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-800">Upload PDF</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>

        <div class="border-2 border-dashed border-indigo-200 rounded-2xl p-8 text-center bg-indigo-50/50 hover:bg-indigo-50 transition cursor-pointer relative" id="dropZone">
            <input type="file" id="pdfFile" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="updateFileName()">
            <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center mx-auto shadow-lg mb-4">
                <i class="fa-solid fa-cloud-arrow-up text-white text-2xl"></i>
            </div>
            <p class="text-sm font-medium text-gray-700">Click to upload PDF</p>
            <div id="fileName" class="text-xs text-indigo-600 mt-2">No file selected</div>
        </div>

        <button onclick="uploadPdf()" class="w-full gradient-bg text-white py-3.5 rounded-xl font-semibold mt-6 shadow-lg hover:opacity-90 transition">
            Upload & Process
        </button>
        <p id="uploadStatus" class="text-center text-sm mt-4 h-5"></p>
    </div>
</div>

<script>
    // --- Logic ---
    function closeModal() {
        document.getElementById('uploadModal').classList.add('hidden');
        document.getElementById('uploadStatus').innerText = "";
    }
    function openModal() {
        document.getElementById('uploadModal').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('modalContent').classList.remove('scale-95');
            document.getElementById('modalContent').classList.add('scale-100');
        }, 10);
    }
    function updateFileName() {
        const file = document.getElementById('pdfFile').files[0];
        if(file) document.getElementById('fileName').innerText = file.name;
    }
    function handleEnter(e) {
        if (e.key === 'Enter') askQuestion();
    }
    function suggestQuestion(q) {
        document.getElementById('questionInput').value = q;
        askQuestion();
    }

    // --- Voice Recognition Logic (Real One) ---
    function startVoiceRecognition() {
        const btn = document.getElementById('voiceBtn');
        if ('webkitSpeechRecognition' in window) {
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.start();

            btn.classList.add('bg-red-100', 'text-red-600', 'animate-pulse');

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                document.getElementById('questionInput').value = text;
                btn.classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
                askQuestion(); // Auto send
            };

            recognition.onerror = function() {
                btn.classList.remove('bg-red-100', 'text-red-600', 'animate-pulse');
                alert("Voice input failed. Try again.");
            };
        } else {
            alert("Browser doesn't support Voice Input.");
        }
    }

    // --- API Calls ---
    async function uploadPdf() {
        const fileInput = document.getElementById('pdfFile');
        const status = document.getElementById('uploadStatus');

        if (!fileInput.files[0]) {
            status.innerText = "Please select a file first!";
            status.className = "text-center text-sm mt-4 text-red-500 font-bold";
            return;
        }

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        status.innerText = "Processing... Please wait...";
        status.className = "text-center text-sm mt-4 text-indigo-600 animate-pulse";

        try {
            const res = await fetch('/api/chat/upload', { method: 'POST', body: formData });
            const text = await res.text();
            status.innerText = "Success! " + text;
            status.className = "text-center text-sm mt-4 text-green-600 font-bold";
            setTimeout(closeModal, 1500);
            addMessage("I've read the PDF. Ready for your questions!", "ai");
        } catch (e) {
            status.innerText = "Error uploading file.";
            status.className = "text-center text-sm mt-4 text-red-500 font-bold";
        }
    }

    async function askQuestion() {
        const input = document.getElementById('questionInput');
        const question = input.value.trim();
        if (!question) return;

        addMessage(question, 'user');
        input.value = '';
        showLoading();

        try {
            const res = await fetch(`/api/chat?message=${encodeURIComponent(question)}`);
            const text = await res.text();
            removeLoading();
            addMessage(text, 'ai');
        } catch (e) {
            removeLoading();
            addMessage("Connection Error!", "ai");
        }
    }

    function addMessage(text, sender) {
        const chatBox = document.getElementById('chat-box');
        const isUser = sender === 'user';
        const div = document.createElement('div');
        div.className = `flex items-start gap-4 message-animation ${isUser ? 'flex-row-reverse' : ''}`;

        const icon = isUser ? '<i class="fa-solid fa-user text-white"></i>' : '<i class="fa-solid fa-robot text-indigo-500"></i>';
        const iconBg = isUser ? 'bg-slate-600' : 'bg-indigo-100';
        const bgClass = isUser ? 'bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-tr-none shadow-md' : 'bg-white text-gray-700 rounded-tl-none shadow-sm border border-indigo-100/50 markdown-body';
        const content = isUser ? text : marked.parse(text);

        div.innerHTML = `
                <div class="w-10 h-10 rounded-xl ${iconBg} flex items-center justify-center flex-shrink-0 shadow-md">${icon}</div>
                <div class="${bgClass} p-4 rounded-2xl max-w-[85%] overflow-hidden leading-relaxed">${content}</div>
            `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showLoading() {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.id = 'loading-bubble';
        div.className = 'flex items-start gap-4 message-animation';
        div.innerHTML = `
                <div class="w-10 h-10 rounded-xl bg-indigo-100 flex items-center justify-center shadow-md"><i class="fa-solid fa-robot text-indigo-500"></i></div>
                <div class="bg-white p-4 rounded-2xl rounded-tl-none shadow-sm border border-indigo-100/50 flex gap-2">
                    <div class="w-2 h-2 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 rounded-full typing-dot"></div>
                    <div class="w-2 h-2 rounded-full typing-dot"></div>
                </div>
            `;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function removeLoading() {
        const l = document.getElementById('loading-bubble');
        if(l) l.remove();
    }
</script>
</body>
</html>